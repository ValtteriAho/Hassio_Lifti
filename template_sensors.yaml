# Template sensorit - Muotoilee bussiaikataulut luettaviksi
# K√§ytet√§√§n configuration.yaml:ssa: template: !include bussiaikataulu/template_sensors.yaml

# Pys√§kki 1 - Muotoiltu aikataulu
- sensor:
      - name: "Bussiaikataulu Pys√§kki 1"
        unique_id: bussiaikataulu_pysakki_1
        state: >
          {% set data = state_attr('sensor.bussi_pysakki_1_raw', 'stoptimesWithoutPatterns') %}
          {% if data and data|length > 0 %}
            {% set departure = data[0] %}
            {% set service_day = departure.serviceDay %}
            {% set realtime_dep = departure.realtimeDeparture %}
            {% set departure_time = service_day + realtime_dep %}
            {% set now_timestamp = as_timestamp(now()) %}
            {% set minutes_until = ((departure_time - now_timestamp) / 60) | int %}
            {% if minutes_until < 1 %}
              L√§htee nyt
            {% else %}
              {{ minutes_until }} min
            {% endif %}
          {% else %}
            Ei l√§ht√∂j√§
          {% endif %}
        attributes:
          lahto_1: >
            {% set data = state_attr('sensor.bussi_pysakki_1_raw', 'stoptimesWithoutPatterns') %}
            {% if data and data|length > 0 %}
              {% set d = data[0] %}
              {% set departure_time = d.serviceDay + d.realtimeDeparture %}
              {% set minutes = ((departure_time - as_timestamp(now())) / 60) | int %}
              {{ d.trip.route.shortName }} ‚Üí {{ d.headsign }} | {{ (departure_time | timestamp_custom('%H:%M')) }} ({{ minutes }} min){{ ' üî¥' if d.realtime else '' }}
            {% endif %}
          lahto_2: >
            {% set data = state_attr('sensor.bussi_pysakki_1_raw', 'stoptimesWithoutPatterns') %}
            {% if data and data|length > 1 %}
              {% set d = data[1] %}
              {% set departure_time = d.serviceDay + d.realtimeDeparture %}
              {% set minutes = ((departure_time - as_timestamp(now())) / 60) | int %}
              {{ d.trip.route.shortName }} ‚Üí {{ d.headsign }} | {{ (departure_time | timestamp_custom('%H:%M')) }} ({{ minutes }} min){{ ' üî¥' if d.realtime else '' }}
            {% endif %}
          lahto_3: >
            {% set data = state_attr('sensor.bussi_pysakki_1_raw', 'stoptimesWithoutPatterns') %}
            {% if data and data|length > 2 %}
              {% set d = data[2] %}
              {% set departure_time = d.serviceDay + d.realtimeDeparture %}
              {% set minutes = ((departure_time - as_timestamp(now())) / 60) | int %}
              {{ d.trip.route.shortName }} ‚Üí {{ d.headsign }} | {{ (departure_time | timestamp_custom('%H:%M')) }} ({{ minutes }} min){{ ' üî¥' if d.realtime else '' }}
            {% endif %}
          lahto_4: >
            {% set data = state_attr('sensor.bussi_pysakki_1_raw', 'stoptimesWithoutPatterns') %}
            {% if data and data|length > 3 %}
              {% set d = data[3] %}
              {% set departure_time = d.serviceDay + d.realtimeDeparture %}
              {% set minutes = ((departure_time - as_timestamp(now())) / 60) | int %}
              {{ d.trip.route.shortName }} ‚Üí {{ d.headsign }} | {{ (departure_time | timestamp_custom('%H:%M')) }} ({{ minutes }} min){{ ' üî¥' if d.realtime else '' }}
            {% endif %}
          lahto_5: >
            {% set data = state_attr('sensor.bussi_pysakki_1_raw', 'stoptimesWithoutPatterns') %}
            {% if data and data|length > 4 %}
              {% set d = data[4] %}
              {% set departure_time = d.serviceDay + d.realtimeDeparture %}
              {% set minutes = ((departure_time - as_timestamp(now())) / 60) | int %}
              {{ d.trip.route.shortName }} ‚Üí {{ d.headsign }} | {{ (departure_time | timestamp_custom('%H:%M')) }} ({{ minutes }} min){{ ' üî¥' if d.realtime else '' }}
            {% endif %}
          pysakki_nimi: "{{ states('sensor.bussi_pysakki_1_raw') }}"
          pysakki_koodi: "{{ state_attr('sensor.bussi_pysakki_1_raw', 'code') }}"

# Pys√§kki 2 - Muotoiltu aikataulu
- sensor:
      - name: "Bussiaikataulu Pys√§kki 2"
        unique_id: bussiaikataulu_pysakki_2
        state: >
          {% set data = state_attr('sensor.bussi_pysakki_2_raw', 'stoptimesWithoutPatterns') %}
          {% if data and data|length > 0 %}
            {% set departure = data[0] %}
            {% set service_day = departure.serviceDay %}
            {% set realtime_dep = departure.realtimeDeparture %}
            {% set departure_time = service_day + realtime_dep %}
            {% set now_timestamp = as_timestamp(now()) %}
            {% set minutes_until = ((departure_time - now_timestamp) / 60) | int %}
            {% if minutes_until < 1 %}
              L√§htee nyt
            {% else %}
              {{ minutes_until }} min
            {% endif %}
          {% else %}
            Ei l√§ht√∂j√§
          {% endif %}
        attributes:
          lahto_1: >
            {% set data = state_attr('sensor.bussi_pysakki_2_raw', 'stoptimesWithoutPatterns') %}
            {% if data and data|length > 0 %}
              {% set d = data[0] %}
              {% set departure_time = d.serviceDay + d.realtimeDeparture %}
              {% set minutes = ((departure_time - as_timestamp(now())) / 60) | int %}
              {{ d.trip.route.shortName }} ‚Üí {{ d.headsign }} | {{ (departure_time | timestamp_custom('%H:%M')) }} ({{ minutes }} min){{ ' üî¥' if d.realtime else '' }}
            {% endif %}
          lahto_2: >
            {% set data = state_attr('sensor.bussi_pysakki_2_raw', 'stoptimesWithoutPatterns') %}
            {% if data and data|length > 1 %}
              {% set d = data[1] %}
              {% set departure_time = d.serviceDay + d.realtimeDeparture %}
              {% set minutes = ((departure_time - as_timestamp(now())) / 60) | int %}
              {{ d.trip.route.shortName }} ‚Üí {{ d.headsign }} | {{ (departure_time | timestamp_custom('%H:%M')) }} ({{ minutes }} min){{ ' üî¥' if d.realtime else '' }}
            {% endif %}
          lahto_3: >
            {% set data = state_attr('sensor.bussi_pysakki_2_raw', 'stoptimesWithoutPatterns') %}
            {% if data and data|length > 2 %}
              {% set d = data[2] %}
              {% set departure_time = d.serviceDay + d.realtimeDeparture %}
              {% set minutes = ((departure_time - as_timestamp(now())) / 60) | int %}
              {{ d.trip.route.shortName }} ‚Üí {{ d.headsign }} | {{ (departure_time | timestamp_custom('%H:%M')) }} ({{ minutes }} min){{ ' üî¥' if d.realtime else '' }}
            {% endif %}
          lahto_4: >
            {% set data = state_attr('sensor.bussi_pysakki_2_raw', 'stoptimesWithoutPatterns') %}
            {% if data and data|length > 3 %}
              {% set d = data[3] %}
              {% set departure_time = d.serviceDay + d.realtimeDeparture %}
              {% set minutes = ((departure_time - as_timestamp(now())) / 60) | int %}
              {{ d.trip.route.shortName }} ‚Üí {{ d.headsign }} | {{ (departure_time | timestamp_custom('%H:%M')) }} ({{ minutes }} min){{ ' üî¥' if d.realtime else '' }}
            {% endif %}
          lahto_5: >
            {% set data = state_attr('sensor.bussi_pysakki_2_raw', 'stoptimesWithoutPatterns') %}
            {% if data and data|length > 4 %}
              {% set d = data[4] %}
              {% set departure_time = d.serviceDay + d.realtimeDeparture %}
              {% set minutes = ((departure_time - as_timestamp(now())) / 60) | int %}
              {{ d.trip.route.shortName }} ‚Üí {{ d.headsign }} | {{ (departure_time | timestamp_custom('%H:%M')) }} ({{ minutes }} min){{ ' üî¥' if d.realtime else '' }}
            {% endif %}
          pysakki_nimi: "{{ states('sensor.bussi_pysakki_2_raw') }}"
          pysakki_koodi: "{{ state_attr('sensor.bussi_pysakki_2_raw', 'code') }}"

# Yhdistetty n√§kym√§ - N√§ytt√§√§ molemmat pys√§kit yhdess√§
- sensor:
      - name: "Bussiaikataulu Yhdistetty"
        unique_id: bussiaikataulu_yhdistetty
        state: >
          {% set p1 = states('sensor.bussiaikataulu_pysakki_1') %}
          {% set p2 = states('sensor.bussiaikataulu_pysakki_2') %}
          {% if p1 != 'Ei l√§ht√∂j√§' %}
            Seuraava: {{ p1 }}
          {% elif p2 != 'Ei l√§ht√∂j√§' %}
            Seuraava: {{ p2 }}
          {% else %}
            Ei l√§ht√∂j√§
          {% endif %}
        attributes:
          kaikki_lahdot: |
            PYS√ÑKKI 1: {{ state_attr('sensor.bussiaikataulu_pysakki_1', 'pysakki_nimi') }}
            {% for i in range(1, 6) %}
            {% set attr_name = 'lahto_' ~ i %}
            {% set lahto = state_attr('sensor.bussiaikataulu_pysakki_1', attr_name) %}
            {% if lahto %}
            {{ i }}. {{ lahto }}
            {% endif %}
            {% endfor %}
            
            PYS√ÑKKI 2: {{ state_attr('sensor.bussiaikataulu_pysakki_2', 'pysakki_nimi') }}
            {% for i in range(1, 6) %}
            {% set attr_name = 'lahto_' ~ i %}
            {% set lahto = state_attr('sensor.bussiaikataulu_pysakki_2', attr_name) %}
            {% if lahto %}
            {{ i }}. {{ lahto }}
            {% endif %}
            {% endfor %}
